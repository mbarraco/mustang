{% extends "stock/base.html" %}
{% load humanize currency %}

{% block title %}Portfolio summary · {{ subject_user.get_full_name|default:subject_user.username }}{% endblock %}
{% block nav_portfolio_active %}active{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h3 mb-0">Portfolio summary</h1>
        <p class="text-muted mb-0">{{ subject_user.get_full_name|default:subject_user.username }}</p>
      </div>
      <a class="btn btn-outline-secondary" href="{% url 'stock:user-operation-timeline' user_id=subject_user.id %}">
        ← Back to timeline
      </a>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <h2 class="h6 text-muted">Held quantity</h2>
            <p class="h4 mb-0">{{ portfolio_totals.running_quantity|floatformat:0 }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <h2 class="h6 text-muted">Cost basis</h2>
            <p class="h4 mb-0">{{ portfolio_totals.running_cost|minor_to_major|floatformat:2|intcomma }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <h2 class="h6 text-muted">Market value</h2>
            <p class="h4 mb-0">{{ portfolio_totals.market_value|minor_to_major|floatformat:2|intcomma }}</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card">
          <div class="card-body">
            <h2 class="h6 text-muted">Unrealized gain</h2>
            <p class="h4 mb-0">{{ portfolio_totals.unrealized_gain|minor_to_major|floatformat:2|intcomma }}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header">Overview for each instrument</div>
      <div class="card-body p-0">
        <table class="table table-striped mb-0 align-middle">
          <thead>
            <tr>
              <th>Instrument</th>
              <th>Quantity</th>
              <th class="text-nowrap">
                Weighted avg price
                <span
                  class="text-muted"
                  role="img"
                  aria-label="Weighted average price rounding info"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  data-bs-title="Displayed value rounded to 2 decimals; hover the value to see the 4-decimal precision."
                >
                  ⓘ
                </span>
              </th>
              <th>Latest price</th>
              <th>Cost basis</th>
              <th>Market value</th>
              <th>Unrealized gain</th>
              <th>Realized P&L</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% if summaries %}
              {% for summary in summaries %}
                <tr>
                  <td>{{ summary.instrument.symbol }}</td>
                  <td>{{ summary.running_quantity|floatformat:0 }}</td>
                  <td>
                    {% if summary.weighted_average_price %}
                      <span
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        data-bs-title="{{ summary.weighted_average_price|minor_to_major|floatformat:4|intcomma }}"
                      >
                        {{ summary.weighted_average_price|minor_to_major|floatformat:2|intcomma }}
                      </span>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    {% if summary.latest_snapshot %}
                      {{ summary.latest_snapshot.price|minor_to_major|floatformat:2|intcomma }}
                      <small class="text-muted d-block">{{ summary.latest_snapshot.as_of|date:"Y-m-d H:i" }}</small>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>{{ summary.running_cost|minor_to_major|floatformat:2|intcomma }}</td>
                  <td>
                    {% if summary.market_value %}
                      {{ summary.market_value|minor_to_major|floatformat:2|intcomma }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td class="{% if summary.unrealized_gain %}text-{% if summary.unrealized_gain >= 0 %}success{% else %}danger{% endif %}{% else %}text-muted{% endif %}">
                    {% if summary.unrealized_gain %}
                      {{ summary.unrealized_gain|minor_to_major|floatformat:2|intcomma }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td class="text-{% if summary.total_realized >= 0 %}success{% else %}danger{% endif %}">
                    {{ summary.total_realized|minor_to_major|floatformat:2|intcomma }}
                  </td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-primary" href="{% url 'stock:instrument-performance' user_id=subject_user.id instrument_id=summary.instrument.id %}">
                      Details
                    </a>
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="9" class="text-center text-muted py-4">No operations found.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="mb-5">
    <div class="alert alert-secondary">
      <strong>How to read these numbers</strong>
      <table class="table table-bordered mt-3 mb-0">
        <thead class="table-light">
          <tr>
            <th>Metric</th>
            <th>Formula</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Cost basis</td>
            <td>∑ (buy quantity × buy price) − ∑ (sold quantity × average cost)</td>
            <td>Total capital you currently have invested in the position.</td>
          </tr>
          <tr>
            <td>Market value</td>
            <td>Shares held × Latest price</td>
            <td>What the position would be worth at the most recent quote.</td>
          </tr>
          <tr>
            <td>Unrealized gain</td>
            <td>Market value − Cost basis</td>
            <td>Profit/loss that remains on paper until you sell.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach(function (tooltipTriggerEl) {
        new bootstrap.Tooltip(tooltipTriggerEl);
      });
    });
  </script>
{% endblock %}
