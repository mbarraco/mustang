{% extends "stock/base.html" %}
{% load humanize currency %}

{% block title %}Stock operations · {{ subject_user.get_full_name|default:subject_user.username }}{% endblock %}
{% block nav_timeline_active %}active{% endblock %}
{% block extra_head %}
  <style>
    .table { font-size: 0.9rem; }
    .table thead th {
      background-color: rgba(156, 183, 199, 0.5);
      font-size: 0.85rem;
    }
    .table td { vertical-align: middle; }
    .table-responsive { border-radius: 0.5rem; overflow: hidden; }
  </style>
{% endblock %}

{% block content %}
    <div class="d-flex align-items-baseline justify-content-between flex-wrap gap-2">
      <h1 class="display-6 mb-0">
        Stock operations for {{ subject_user.get_full_name|default:subject_user.username }}
      </h1>
      <a class="btn btn-outline-secondary" href="{% url 'stock:portfolio-summary' user_id=subject_user.id %}">
        Portfolio summary
      </a>
    </div>

    <form method="get" class="row gy-2 gx-3 align-items-center mt-3">
      <div class="col-auto">
        <label class="form-label fw-semibold mb-1" for="instrument">Instrument</label>
        <select id="instrument" name="instrument" class="form-select" onchange="this.form.submit()">
          <option value="">All instruments</option>
          {% for instrument_id, symbol in instrument_choices %}
            {% with instrument_id_str=instrument_id|stringformat:"s" %}
              <option value="{{ instrument_id_str }}" {% if selected_instrument_id == instrument_id_str %}selected{% endif %}>{{ symbol }}</option>
            {% endwith %}
          {% endfor %}
        </select>
      </div>
      <noscript class="col-auto mt-4 pt-2">
        <button type="submit" class="btn btn-primary">Apply</button>
      </noscript>
    </form>

    {% if refresh_status %}
      <div class="alert alert-success mt-3" role="alert">
        {{ refresh_status }}
      </div>
    {% elif refresh_error %}
      <div class="alert alert-danger mt-3" role="alert">
        {{ refresh_error }}
      </div>
    {% endif %}

    {% if timeline_entries %}
      <div class="table-responsive shadow-sm mt-4">
        <table class="table table-striped table-hover align-middle mb-0">
          <thead>
            <tr>
              <th scope="col">Timestamp</th>
              <th scope="col">Operation</th>
              <th scope="col">Quantity</th>
              <th scope="col">Instrument</th>
              <th scope="col">Price</th>
              <th scope="col">Currency</th>
              <th scope="col">Fees</th>
              <th scope="col">Total Value</th>
              <th scope="col">Exchange</th>
              <th scope="col">Running Qty</th>
              <th scope="col">Weighted Avg Price</th>
              <th scope="col">Latest Price</th>
              <th scope="col" class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in timeline_entries %}
              {% with operation=entry.operation %}
              <tr>
                <td>{{ operation.timestamp|date:"Y-m-d H:i" }}</td>
                <td>
                  <span class="badge {% if operation.operation_type|lower == 'buy' %}text-bg-success{% elif operation.operation_type|lower == 'sell' %}text-bg-danger{% else %}text-bg-secondary{% endif %}">
                    {{ operation.get_operation_type_display }}
                  </span>
                </td>
                <td>{{ operation.quantity|floatformat:0 }}</td>
                <td>
                  <a href="{% url 'stock:instrument-performance' user_id=subject_user.id instrument_id=operation.instrument.id %}">
                    {{ operation.instrument.symbol }}
                  </a>
                </td>
                <td>{{ operation.price|minor_to_major|floatformat:2|intcomma }}</td>
                <td>{{ operation.get_currency_display }}</td>
                <td>{{ operation.fees|minor_to_major|floatformat:2|intcomma }}</td>
                <td>{{ operation.total_value|minor_to_major|floatformat:2|intcomma }}</td>
                <td>{{ operation.instrument.exchange.code }}</td>
                <td>
                  {% if entry.running_quantity %}
                    {{ entry.running_quantity|floatformat:0 }}
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td>
                  {% if entry.weighted_average_price %}
                    {{ entry.weighted_average_price|minor_to_major|floatformat:2|intcomma }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>
                  {% if entry.latest_snapshot %}
                    {{ entry.latest_snapshot.price|minor_to_major|floatformat:2|intcomma }}
                    <small class="text-muted d-block">
                      {{ entry.latest_snapshot.as_of|date:"Y-m-d H:i" }}
                    </small>
                  {% else %}
                    ---
                  {% endif %}
                </td>
                <td class="text-end">
                  <form method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="refresh_instrument_id" value="{{ operation.instrument.id }}">
                    <button type="submit" class="btn btn-outline-primary btn-sm">
                      Refresh
                    </button>
                  </form>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info mt-4" role="alert">
        No operations recorded for this user.
      </div>
    {% endif %}
{% endblock %}
