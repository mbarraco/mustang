<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ instrument.symbol }} performance for {{ subject_user.get_full_name|default:subject_user.username }}</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >
</head>
{% load humanize %}
<body class="bg-light">
  <div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h3 mb-0">{{ instrument.symbol }} performance</h1>
        <p class="text-muted mb-0">
          {{ subject_user.get_full_name|default:subject_user.username }}
        </p>
      </div>
      <a class="btn btn-outline-secondary" href="{% url 'stock:user-operation-timeline' user_id=subject_user.id %}">
        ← Back to timeline
      </a>
    </div>

    <div class="row g-4">
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h2 class="h6 text-muted">Current holdings</h2>
            <p class="h4 mb-1">{{ running_quantity|floatformat:0 }} shares</p>
            <p class="text-muted mb-0">
              Cost basis: {{ running_cost|floatformat:2|intcomma }}
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h2 class="h6 text-muted">Unrealized gain</h2>
            {% if latest_snapshot and market_value %}
              <p class="h4 mb-1">{{ unrealized_gain|floatformat:2|intcomma }}</p>
              <p class="text-muted mb-0">
                Market value {{ market_value|floatformat:2|intcomma }} = {{ running_quantity|floatformat:0 }} × {{ latest_snapshot.price|floatformat:2|intcomma }} ({{ latest_snapshot.as_of|date:"Y-m-d H:i" }})
              </p>
            {% else %}
              <p class="mb-0">No market data available.</p>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h2 class="h6 text-muted">Total realized P&L</h2>
            <p class="h4 mb-0 text-{% if total_realized >= 0 %}success{% else %}danger{% endif %}">
                {{ total_realized|floatformat:2|intcomma }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">
        Realized trades
      </div>
      <div class="card-body p-0">
        <table class="table table-striped mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Quantity</th>
              <th>Avg cost</th>
              <th>Sale price</th>
              <th>Realized P&L</th>
            </tr>
          </thead>
          <tbody>
            {% if realized_entries %}
              {% for entry in realized_entries %}
                <tr>
                  <td>{{ entry.operation.timestamp|date:"Y-m-d H:i" }}</td>
                  <td>{{ entry.quantity|floatformat:0 }}</td>
                  <td>{{ entry.avg_cost|floatformat:2|intcomma }}</td>
                  <td>{{ entry.sale_price|floatformat:2|intcomma }}</td>
                  <td class="text-{% if entry.realized >= 0 %}success{% else %}danger{% endif %}">
                    {{ entry.realized|floatformat:2|intcomma }}
                  </td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  No sell operations recorded yet.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body>
</html>
